<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link href="/assets/style/pack.css" rel="stylesheet"> -->
    <link href="/assets/style/main.css" rel="stylesheet" />
    <script src="/assets/js/pack.js"></script>
    <title>thunk juice - marshmallow-select: alpha junkware to crash your servers</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div id="main" role="main" class="main">
      <div id="headline">
  <div id="top-slice">
    <div id="titlebox">
      <h1 id="title-link"><a href="/" class="title">thunk juice</a></h1>
      <p id="subtitle" data-turbolinks-permanent></p>
    </div>
    <div id="logobox">
      <img src="/assets/img/mpga.png" id="mpga" alt="Mpga" />
    </div>
  </div>
  <div id="navbits">
    <a href="misc/me.html">me</a> |
    <a href="misc/site.html">site</a> |
    <a href="misc/contact.html">contact</a> |
    <a href="https://github.com/dradetsky">github</a> |
    <a href="https://bitbucket.org/dradetsky">bitbucket</a> |
    <a href="feed.xml">feed</a>
  </div>
</div>


        <div id="blogbox">
    <div id="article-col">
      <div class="articles-main">
          <article>
    <header>
      <h2 class="article-title">
        
        marshmallow-select: alpha junkware to crash your servers
      </h2>
    </header>
    <div class="article-body">
      <p>This is to announce the publication of my package 
<a href="https://github.com/marshmallow-code/marshmallow-select">marshmallow-select</a>,
formerly part of the <a href="https://distribute.com">Distribute</a> corporate
repo, but since moved to
<a href="https://github.com/marshmallow-code/">marshmallow-code</a>.</p>

<p>As the <a href="http://docs.sqlalchemy.org/en/latest/">sqlalchemy docs</a>
cogently point out, the biggest problem people usually have with ORM
frameworks is the accidental introduction of N+1 query bugs.
<a href="http://docs.sqlalchemy.org/en/latest/glossary.html#term-n-plus-one-problem">These are</a></p>

<blockquote>
<p>...a common side effect of the lazy load pattern, whereby an
application wishes to iterate through a related attribute or
collection on each member of a result set of objects, where that
attribute or collection is set to be loaded via the lazy load
pattern. The net result is that a SELECT statement is emitted to
load the initial result set of parent objects; then, as the
application iterates through each member, an additional SELECT
statement is emitted for each member in order to load the related
attribute or collection for that member. The end result is that for
a result set of N parent objects, there will be N + 1 SELECT
statements emitted.</p>
</blockquote>

<p>The solution offered by sqlalchemy is to declare relationships as
<a href="http://docs.sqlalchemy.org/en/latest/orm/loading_relationships.html"><code class="inline-code">'raiseload'</code></a>.
This means that while the relationship in question is not loaded by
default, if it is loaded at all, it must be loaded eagerly: that is,
via a join. Failing to eagerly load the relationship raises an error.
Within the confines of sqlalchemy itself, I agree that there really
isn&#39;t any better solution. So without wishing to cast aspersions on
the illustrious authors of sqlalchemy, I still say it&#39;s an extremely
unsatisfying solution for two reasons.</p>

<p>First, N+1 query problems are only really problematic for large N.
When you fetch the list of all User records for display on your webapp
frontend, each one firing off an extra query (especially sychronously
at serialization time) is a big problem. When you fetch a single User
object to display a more detailed version, such as a profile view, the
fact that you might execute 3 or 4 queries instead of 1 is not the end
of the world. But your user detail view suddenly crashing for everyone
in production as a side effect of your attempts to optimize the user
list view might be somewhat more serious. This can be avoid with good
unit and integration testing, <em>if you do them</em>. We all have limited
time budgets we can&#39;t afford to fritter away on extra unit tests (or
open-source software libraries, or blog posts). And if I had a nickel
for every mediocre unit test I&#39;ve seen which didn&#39;t actually catch the
issue it was supposed to catch, I&#39;d have, I dunno, busfare maybe?
Still, SF MUNI&#39;s actually not cheap.</p>

<p>Second, it not only requires extra risk, but extra work fiddling with
query parameters. You have to go through and manually set all the
relationship options to joinload every time you want to fetch them.
This sucks. Can we do better?</p>

<p>I think so. If you&#39;re like me (except, statistically speaking, less
handsome and charming), you&#39;re probably fetching these objects as part
of a web application with the ultimate goal of serializing them and
sending them so some kind of frontend single-page app. You probably
also realize that actually serializing the objects by hand is a
terrible idea,<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup> and a much better idea is to use a library like
<a href="https://github.com/marshmallow-code/marshmallow">marshmallow</a> (or
possibly <a href="https://github.com/marshmallow-code/marshmallow-sqlalchemy">marshmallow-sqlalchemy</a>)
to do the work for you. Such a library is used to define a <em>schema</em>
for (among other things) controlling the serialization of your objects.</p>

<p>You probably also realize that since various views want various
different subsets of the total fields of an object, it makes sense to
define pared-down schemas for a particular view (possibly via
marshmallow&#39;s <code class="inline-code">fields</code> or <code class="inline-code">exclude</code> metaclass options). These
pared-down subschemas define a subset of the possible fields to be
fetched for an object, and represent exactly what you want to send
back. So what if you told sqlalchemy to fetch exactly what was needed
to populate a given schema?</p>

<p>This is the idea of marshmallow-select, so called because it uses the
marshmallow schema to generate (ultimately, via sqlalchemy) the body
of the SQL <code class="inline-code">SELECT</code> clause. Rather than manually modifying the query
options to exclude certain unneeded fields or eagerly load certain
related objects, marshmallow-select will use your schema to walk the
query tree, pulling in everything you intend to use and <code class="inline-code">defer</code>-ing or
<code class="inline-code">noload</code>-ing the rest.</p>

<p>But don&#39;t take my word for it. Get yourself
<a href="https://github.com/Distribute-Inc/marshmallow-select">a copy</a> and try
it out. NOTE: The management is not responsible for any lost data,
production downtime, accidental death, etc. resulting from the use of
our software, although we do take a kind of perverse pride in it.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>The guy who built the backend api server I&#39;ve taken over did
<em>not</em> realize this, but never mind.&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

    </div>
  </article>

      </div>
    </div>
    <div id="sidebar-col">
      <div id="sidebar">
        <h2 class="sidebar-title-top">Recent Articles</h2>
<ol class="sidebar-list">
    <li><a href="marshmallow-select.html">marshmallow-select: alpha j...</a> <span>26 May</span></li>
    <li><a href="codebloggers-apology.html">A Codeblogger's Apology</a> <span>24 May</span></li>
</ol>

<h2 class="sidebar-title">Tags</h2>
<ol class="sidebar-list">
    <li><a href="tags/intro.html">intro (1)</a></li>
    <li><a href="tags/python.html">python (1)</a></li>
    <li><a href="tags/marshmallow.html">marshmallow (1)</a></li>
    <li><a href="tags/sqlalchemy.html">sqlalchemy (1)</a></li>
    <li><a href="tags/open-source.html">open-source (1)</a></li>
    <li><a href="tags/marshmallow-select.html">marshmallow-select (1)</a></li>
</ol>

<h2 class="sidebar-title">By Year</h2>
<ol class="sidebar-list">
    <li><a href="ark/2017.html">2017 (2)</a></li>
</ol>

      </div>
    </div>
  </div>

    </div>
  </body>
</html>
