<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link href="/assets/style/pack.css" rel="stylesheet"> -->
    <link href="/assets/style/main.css" rel="stylesheet" />
    <script src="/assets/js/pack.js"></script>
    <title>thunk juice - Fun with marshmallow-select</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div id="main" role="main" class="main">
      <div id="headline">
  <div id="top-slice">
    <div id="titlebox">
      <h1 id="title-link"><a href="/" class="title">thunk juice</a></h1>
      <p id="subtitle" data-turbolinks-permanent></p>
    </div>
    <div id="logobox">
      <img src="/assets/img/mpga.png" id="mpga" alt="Mpga" />
    </div>
  </div>
  <div id="navbits">
    <a href="misc/me.html">me</a> |
    <a href="misc/site.html">site</a> |
    <a href="misc/contact.html">contact</a> |
    <a href="https://github.com/dradetsky">github</a> |
    <a href="https://bitbucket.org/dradetsky">bitbucket</a> |
    <a href="feed.xml">feed</a>
  </div>
</div>


        <div id="blogbox">
    <div id="article-col">
      <div class="articles-main">
          <article>
    <header>
      <h2 class="article-title">
        
        Fun with marshmallow-select
      </h2>
    </header>
    <div class="article-body">
      <h3>The fun starts here</h3>

<p>My original announcement of
<a href="https://github.com/marshmallow-code/marshmallow-select">marshmallow-select</a> was
unfortunately short on examples of what could be done with it. Let&#39;s fix that.</p>

<p>Consider a server application with a minimal user model (ommitting pks &amp; relationships)</p>
<pre class="high"><code class="python">class User(Base):
    first_name = Column(String(100))
    last_name = Column(String(100))
    email = Column(String(100))
</code></pre>
<p>such that users have zero or more images associated with their account</p>
<pre class="high"><code class="python">class Image(Base):
    url = Column(String(100))
    user_id = Column(Integer, ForeignKey('user.id'))
</code></pre>
<p>and can <em>like</em> other user&#39;s images<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup></p>
<pre class="high"><code class="python">class Like(Base):
    user_id = Column(Integer, ForeignKey('user.id'))
    image_id = Column(Integer, ForeignKey('image.id'))
</code></pre>
<p>We&#39;ll call the resulting app <em>Shitbook</em>. </p>

<p>Now consider what sorts of subsets of these objects you might want to
show to users in various Shitbook views.</p>

<p>To start with, we&#39;ll use a combination of
<a href="https://marshmallow-sqlalchemy.readthedocs.io/en/latest/recipes.html">marshmallow-select</a>&#39;s
<code class="inline-code">ModelSchema</code> to define a set of &quot;Shallow&quot; schemas containing all the
direct fields of our models, and 
<a href="http://marshmallow.readthedocs.io/en/latest/nesting.html#two-way-nesting">two-way nesting</a>
from plain old
<a href="http://marshmallow.readthedocs.io/en/latest/">marshmallow</a>
to define a set of &quot;Complete&quot; schemas.<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup></p>
<pre class="high"><code class="python">class UserSchema(ShallowUserSchema):
    images = List(Nested('ImageSchema'))
    likes = List(Nested('LikeSchema'))


class ImageSchema(ShallowImageSchema):
    user = Nested('UserSchema')
    users_who_like = List(Nested('UserSchema'))


class LikeSchema(Schema):
    user = Nested('UserSchema')
    image = Nested('ImageSchema')
</code></pre>
<p>Note that these schemas cannot actually be used. For one thing, they
are infinitely recursive. For another, all relationships are lazily
loaded. Attempting to serialize <em>any</em> linked object with them will
result in python rapidly beating your database and itself to death. As
we&#39;ll see, this doesn&#39;t actually matter.<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup></p>

<h3>A details view</h3>

<p>You&#39;d probably have some sort of single-user view (think &quot;user profile
page&quot;) in which you showed all the user&#39;s fields, all his images, and
all his likes. But you probably wouldn&#39;t want to show all subfields of
each image and like. Let&#39;s say that you want to show just all the urls
from the user&#39;s own images, and all the urls from the images that user
has liked. Or, to put it another way:</p>
<pre class="high"><code class="python">class ImageForUserDetailSchema(ImageSchema):
    class Meta:
        fields = ['id', 'url']

class LikeForUserDetailSchema(LikeSchema):
    image = Nested(ImageForUserDetailSchema)

    class Meta:
        fields = ['id', 'image']

class UserDetailSchema(UserSchema):
    images = List(Nested(ImageForUserDetailSchema))
    likes = List(Nested(LikeForUserDetailSchema))
</code></pre>
<p>Now, if you&#39;re crazy like we are at <a href="//distribute.com">Distribute</a>,
and you&#39;re planning to generating typescript interface definitions and
backend method calls from <a href="//swagger.io">swagger</a>, you&#39;ll want
to verify that you can get correct swagger output from 
<a href="https://github.com/marshmallow-code/apispec">apispec</a>.</p>
<pre class="high"><code class="python">spec = APISpec(
    title='detail',
    version='0.0.0',
    plugins=[
        'apispec.ext.marshmallow',
    ],
)
spec.definition('UserDetail', schema=UserDetailSchema)
spec.definition('ImageForUserDetail', schema=ImageForUserDetailSchema)
spec.definition('LikeForUserDetail', schema=LikeForUserDetailSchema)

</code></pre>
<p>which yields the definitions</p>
<pre class="high"><code class="json">
{
    "ImageForUserDetail": {
        "properties": {
            "id": {
                "format": "int32",
                "type": "integer"
            },
            "url": {
                "maxLength": 100,
                "type": "string",
                "x-nullable": true
            }
        },
        "type": "object"
    },
    "LikeForUserDetail": {
        "properties": {
            "id": {
                "format": "int32",
                "type": "integer"
            },
            "image": {
                "$ref": "#/definitions/ImageForUserDetail"
            }
        },
        "type": "object"
    },
    "UserDetail": {
        "properties": {
            "email": {
                "maxLength": 100,
                "type": "string",
                "x-nullable": true
            },
            "first_name": {
                "maxLength": 100,
                "type": "string",
                "x-nullable": true
            },
            "id": {
                "format": "int32",
                "type": "integer"
            },
            "images": {
                "items": {
                    "$ref": "#/definitions/ImageForUserDetail"
                },
                "type": "array"
            },
            "last_name": {
                "maxLength": 100,
                "type": "string",
                "x-nullable": true
            },
            "likes": {
                "items": {
                    "$ref": "#/definitions/LikeForUserDetail"
                },
                "type": "array"
            }
        },
        "type": "object"
    }
}

</code></pre>
<p>Looks fine.</p>

<p>Now let&#39;s fetch and serialize a user according to the
<code class="inline-code">UserDetailSchema</code>, first naively</p>
<pre class="high"><code class="python">qry = session.query(User).filter(User.id==uid)
data = qry.first()
out = OutUserDetailSchema().dump(data).data
</code></pre>
<p>With a running total query counter, we see</p>
<pre><code class="hljs">begin example: user detail
fetching user detail data
queries: 1
serializing user detail data
queries: 4
</code></pre>
<p>To clarify, that means a total of 4 queries: 1 for the original fetch,
and 3 during serialization. You can see the same basic thing in the
<a href="https://github.com/marshmallow-code/marshmallow-select/blob/master/tests/test_marshmallow_select.py#L252">test</a>.</p>

<p>Now we filter first</p>
<pre class="high"><code class="python">qry = session.query(User).filter(User.id==uid)
sf = SchemaFilter(UserDetailSchema(), unlazify=True)
qry = sf(qry)
data = qry.first()
out = OutUserDetailSchema().dump(data).data
</code></pre>
<p>which yields</p>
<pre><code class="hljs">begin example: user detail
fetching user detail data
queries: 1
serializing user detail data
queries: 1
</code></pre>
<p>In other words, all data necessary to produce the message defined by
the schema was retrieved in the initial query.</p>

<h3>A list view</h3>

<p>You&#39;d probably also have some kind of user-list view which shows just
the user&#39;s name and an image. For this, we extend the image model to</p>
<pre class="high"><code class="python">class Image(Base):
    url = Column(String(100))
    user_id = Column(Integer, ForeignKey('user.id'))
    is_default = Column(Boolean, default=False)
</code></pre>
<p>and define an additional relationship</p>
<pre class="high"><code class="python">class User(Base):
    ...
    default_image = relationship(
        'Image',
        uselist=False,
        primaryjoin=(
            "and_(User.id==Image.user_id, "
            "Image.is_default==True)"
        )
    )
</code></pre>
<p>Our schemas are<sup id="fnref4"><a href="#fn4" rel="footnote">4</a></sup></p>
<pre class="high"><code class="python">class ImageForUserListEltSchema(ImageSchema):
    class Meta:
        fields = ['id', 'url']


class UserListEltSchema(UserSchema):
    default_image = Nested(ImageForUserListEltSchema)

    class Meta:
        fields = ['id', 'first_name', 'default_image']
</code></pre>
<p>Once again, with 2 users in our db, we generate 3 queries unfiltered,
and 1 query when <code class="inline-code">SchemaFilter</code>ing on <code class="inline-code">UserListEltSchema</code>. Moreover,
If we subsequently execute</p>
<pre class="high"><code class="python">session.query(Image).get(0).id
session.query(Image).get(1).id
</code></pre>
<p>No additional queries are produced. But then if we continue with</p>
<pre class="high"><code class="python">session.query(Image).get(2).id
</code></pre>
<p>a query <em>is</em> produced, because we fetched only those images which were
linked to a user we were fetching via the <code class="inline-code">default_image</code>
relationship.</p>

<p>So hopefully you now see that neat stuff can be done. I&#39;m also going
to be making the API more convenient (<code class="inline-code">unlazify</code> will be the default,
and be configurable), and improving the performance by allowing the
query&#39;s projection to be computed at application boot time instead of
for every query when executed (and also making computing the
projection much faster). So don&#39;t touch that dial.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>And also, in this example, their own. But this isn&#39;t a
real application.&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>marchmallow-sqlalchemy does not allow you to generate
infinitely-recursive schemas. I think this is in an effort to be
helpful, rather than just to avoid infinite recursion within its
own code.&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

<li id="fn3">
<p>Note that it is not strictly required to define such an
infinitely-recursive schema. Any old legacy schema setup you have
around the codebase will do. But since the primary use-case for
marshmallow-select is avoiding N+1 query bugs, it helps to start
with a limiting case in which recursive N+1 queries are
guaranteed.&nbsp;<a href="#fnref3" rev="footnote">&#8617;</a></p>
</li>

<li id="fn4">
<p>alert readers will notice that <code class="inline-code">ImageForUserListEltSchema</code>
and <code class="inline-code">ImageForUserDetailSchema</code> are identical. I could use a common
schema, but the point is that you could use a different subset of
the fields of <code class="inline-code">Image</code> for the two different views.&nbsp;<a href="#fnref4" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

    </div>
  </article>

      </div>
    </div>
    <div id="sidebar-col">
      <div id="sidebar">
        <h2 class="sidebar-title-top">Recent Articles</h2>
<ol class="sidebar-list">
    <li><a href="fun-with-marsh-select.html">Fun with marshmallow-select</a> <span> 5 Jun</span></li>
    <li><a href="moving-to-arch.html">Moving To Arch Linux: Human...</a> <span>30 May</span></li>
    <li><a href="marshmallow-select.html">marshmallow-select: alpha j...</a> <span>26 May</span></li>
    <li><a href="codebloggers-apology.html">A Codeblogger's Apology</a> <span>24 May</span></li>
</ol>

<h2 class="sidebar-title">Tags</h2>
<ol class="sidebar-list">
    <li><a href="tags/python.html">python (2)</a></li>
    <li><a href="tags/marshmallow.html">marshmallow (2)</a></li>
    <li><a href="tags/sqlalchemy.html">sqlalchemy (2)</a></li>
    <li><a href="tags/open-source.html">open-source (2)</a></li>
    <li><a href="tags/marshmallow-select.html">marshmallow-select (2)</a></li>
    <li><a href="tags/intro.html">intro (1)</a></li>
    <li><a href="tags/arch.html">arch (1)</a></li>
    <li><a href="tags/linux.html">linux (1)</a></li>
    <li><a href="tags/distos.html">distos (1)</a></li>
    <li><a href="tags/ubuntu.html">ubuntu (1)</a></li>
</ol>

<h2 class="sidebar-title">By Year</h2>
<ol class="sidebar-list">
    <li><a href="ark/2017.html">2017 (4)</a></li>
</ol>

      </div>
    </div>
  </div>

    </div>
  </body>
</html>
